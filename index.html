<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåü Chore Chart ‚Äî Lily & Rue</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Permanent+Marker&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --accent: #FF3CAC;
    --accent2: #784BA0;
    --accent3: #2B86C5;
    --gold: #FFD700;
    --dark: #1a1a2e;
    --light: #ffffff;
    --radius: 16px;
    --shadow: 4px 4px 0px rgba(0,0,0,0.5);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    min-height: 100vh;
    overflow-y: auto;
    transition: background 0.8s ease;
  }

  /* ‚îÄ‚îÄ DAILY BACKGROUNDS ‚îÄ‚îÄ */
  body.day-0 { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); }
  body.day-1 { background: linear-gradient(135deg, #1d2671, #c33764); }
  body.day-2 { background: linear-gradient(135deg, #134e5e, #71b280); }
  body.day-3 { background: linear-gradient(135deg, #f7971e, #ffd200, #ff6b6b); }
  body.day-4 { background: linear-gradient(135deg, #360033, #0b8793); }
  body.day-5 { background: linear-gradient(135deg, #642b73, #c6426e); }
  body.day-6 { background: linear-gradient(135deg, #093028, #237a57); }

  /* Graffiti texture overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: 
      radial-gradient(circle at 20% 50%, rgba(255,60,172,0.08) 0%, transparent 60%),
      radial-gradient(circle at 80% 20%, rgba(43,134,197,0.1) 0%, transparent 50%),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: relative; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 20px;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
    border-bottom: 3px solid rgba(255,215,0,0.4);
  }

  .app-title {
    font-family: 'Bangers', cursive;
    font-size: 2.2rem;
    letter-spacing: 3px;
    background: linear-gradient(90deg, #FFD700, #FF3CAC, #2B86C5, #FFD700);
    background-size: 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 4s linear infinite;
    text-shadow: none;
    filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.6));
  }

  @keyframes shimmer { 0% { background-position: 0% } 100% { background-position: 300% } }

  .header-right {
    display: flex; align-items: center; gap: 12px;
  }

  .date-display {
    font-family: 'Permanent Marker', cursive;
    color: var(--gold);
    font-size: 0.95rem;
    text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
  }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tabs {
    display: flex; gap: 0;
    padding: 8px 20px 0;
    position: relative; z-index: 10;
  }

  .tab-btn {
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    letter-spacing: 2px;
    padding: 8px 24px;
    border: 3px solid rgba(255,255,255,0.3);
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    background: rgba(0,0,0,0.3);
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 4px;
  }

  .tab-btn:hover { background: rgba(255,255,255,0.15); color: white; }

  .tab-btn.active {
    background: rgba(0,0,0,0.7);
    color: var(--gold);
    border-color: var(--gold);
    text-shadow: 0 0 20px var(--gold);
  }

  .tab-btn.lily.active { 
    background: linear-gradient(90deg, #FFD700, #FF3CAC, #2B86C5, #6EFF9E, #FFD700);
    background-size: 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 4s linear infinite;
    border-color: #FF6EFF;
    filter: drop-shadow(0 0 8px rgba(255,110,255,0.6));
  }
  .tab-btn.rue.active  { 
    background: linear-gradient(90deg, #FFD700, #FF3CAC, #2B86C5, #6EFF9E, #FFD700);
    background-size: 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 4s linear infinite;
    animation-delay: 0.5s;
    border-color: #6EEFFF;
    filter: drop-shadow(0 0 8px rgba(110,239,255,0.6));
  }
  .tab-btn.cal.active  { color: #6EFF9E; border-color: #6EFF9E; text-shadow: 0 0 20px #6EFF9E; }

  /* ‚îÄ‚îÄ MAIN PANEL ‚îÄ‚îÄ */
  .main-panel {
    position: relative; z-index: 10;
    margin: 0 20px 20px;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(12px);
    border: 3px solid rgba(255,255,255,0.15);
    border-top: 3px solid rgba(255,255,255,0.3);
    border-radius: 0 12px 12px 12px;
    padding: 12px 16px;
    min-height: calc(100vh - 130px);
    overflow: visible;
  }

  .tab-content { display: none; }
  .tab-content.active { display: flex; flex-direction: column; }

  /* ‚îÄ‚îÄ CHILD CHORE TAB ‚îÄ‚îÄ */
  .chore-tab-inner {
    display: flex;
    gap: 12px;
  }

  /* Left: Day selector + Rewards */
  .left-col {
    width: 180px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .day-selector {
    display: flex; flex-direction: column; gap: 4px;
  }

  .day-btn {
    font-family: 'Bangers', cursive;
    font-size: 1rem;
    letter-spacing: 1px;
    padding: 5px 8px;
    border-radius: 8px;
    border: 2px solid transparent;
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.65);
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }
  .day-btn:hover { background: rgba(255,255,255,0.15); color: white; }
  .day-btn.active-day {
    background: linear-gradient(90deg, rgba(255,215,0,0.25), rgba(255,60,172,0.2));
    border-color: var(--gold);
    color: var(--gold);
  }
  .day-btn.weekend { border-color: rgba(110,239,255,0.3); }

  /* Rewards box */
  .rewards-box {
    background: rgba(255,215,0,0.08);
    border: 2px solid rgba(255,215,0,0.35);
    border-radius: 12px;
    padding: 10px;
  }

  .rewards-title {
    font-family: 'Bangers', cursive;
    font-size: 1.2rem;
    letter-spacing: 2px;
    color: var(--gold);
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
    margin-bottom: 6px;
    display: flex; align-items: center; justify-content: space-between;
  }

  .reward-item {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 6px;
    margin-bottom: 3px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    border-left: 3px solid var(--gold);
  }

  .reward-item span { color: rgba(255,255,255,0.85); font-size: 0.78rem; flex: 1; }
  .reward-pts {
    font-family: 'Bangers', cursive;
    color: var(--gold); font-size: 1rem;
  }

  /* Right: Chores */
  .right-col {
    flex: 1;
    display: flex;
    gap: 12px;
  }

  .chore-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .section-header {
    font-family: 'Bangers', cursive;
    font-size: 1.3rem;
    letter-spacing: 2px;
    padding: 4px 10px;
    border-radius: 8px;
    text-align: center;
    text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
  }
  .morning-hdr { background: linear-gradient(90deg, rgba(255,180,0,0.3), rgba(255,100,0,0.2)); color: #FFD27F; border: 1.5px solid rgba(255,180,0,0.4); }
  .afternoon-hdr { background: linear-gradient(90deg, rgba(120,75,160,0.3), rgba(43,134,197,0.2)); color: #C4A0FF; border: 1.5px solid rgba(120,75,160,0.4); }

  .chore-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .chore-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.06);
    border-radius: 10px;
    border: 1.5px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .chore-item::before {
    content: '';
    position: absolute; left: 0; top: 0; bottom: 0;
    width: 4px;
    border-radius: 10px 0 0 10px;
    transition: all 0.2s;
  }
  .morning .chore-item::before { background: #FFD27F; }
  .afternoon .chore-item::before { background: #C4A0FF; }

  .chore-item:hover { background: rgba(255,255,255,0.12); transform: translateX(2px); }

  .chore-item.done {
    background: rgba(100,255,150,0.12);
    border-color: rgba(100,255,150,0.4);
  }
  .chore-item.done .chore-name { text-decoration: line-through; color: rgba(255,255,255,0.4); }

  .chore-check {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2.5px solid rgba(255,255,255,0.35);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    font-size: 0.7rem;
    transition: all 0.2s;
  }
  .chore-item.done .chore-check {
    background: #64ff96;
    border-color: #64ff96;
    color: #0a0a0a;
  }

  .chore-icon { font-size: 1.2rem; flex-shrink: 0; }
  .chore-name { font-size: 0.82rem; font-weight: 700; color: rgba(255,255,255,0.85); flex: 1; }

  /* Stars progress */
  .star-bar {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    border: 1px solid rgba(255,215,0,0.2);
  }
  .stars-count {
    font-family: 'Bangers', cursive;
    color: var(--gold); font-size: 1.1rem;
  }
  .star-icons { flex: 1; display: flex; flex-wrap: wrap; gap: 2px; }
  .star-pip { font-size: 0.9rem; }

  /* Edit button */
  .edit-btn {
    font-family: 'Permanent Marker', cursive;
    font-size: 0.7rem;
    padding: 2px 7px;
    border-radius: 6px;
    border: 1.5px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.2s;
  }
  .edit-btn:hover { background: rgba(255,255,255,0.2); color: white; }

  /* ‚îÄ‚îÄ CALENDAR TAB ‚îÄ‚îÄ */
  .cal-inner {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .cal-nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 4px;
  }

  .cal-title {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    letter-spacing: 3px;
    color: #6EFF9E;
    text-shadow: 0 0 20px rgba(110,255,158,0.5);
  }

  .nav-btn {
    font-size: 1.5rem;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.2);
    color: white;
    border-radius: 8px;
    padding: 4px 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .nav-btn:hover { background: rgba(255,255,255,0.2); }

  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    flex: 1;
  }

  .cal-day-header {
    font-family: 'Bangers', cursive;
    font-size: 0.95rem;
    letter-spacing: 1px;
    text-align: center;
    color: #6EFF9E;
    padding: 2px;
  }

  .cal-cell {
    background: rgba(255,255,255,0.05);
    border: 1.5px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 4px;
    min-height: 80px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .cal-cell:hover { background: rgba(255,255,255,0.1); border-color: rgba(110,255,158,0.4); }
  .cal-cell.today { border-color: #6EFF9E; background: rgba(110,255,158,0.1); }
  .cal-cell.other-month { opacity: 0.35; }

  .cal-date {
    font-family: 'Bangers', cursive;
    font-size: 1rem;
    color: rgba(255,255,255,0.7);
    line-height: 1;
    margin-bottom: 2px;
  }
  .cal-cell.today .cal-date { color: #6EFF9E; }

  .cal-event {
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 4px;
    border-radius: 4px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .event-lily { background: rgba(255,110,255,0.3); color: #FF6EFF; }
  .event-rue  { background: rgba(110,239,255,0.3); color: #6EEFFF; }
  .event-family { background: rgba(110,255,158,0.3); color: #6EFF9E; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: #1a1a2e;
    border: 3px solid var(--gold);
    border-radius: 16px;
    padding: 20px;
    width: 480px;
    max-width: 95vw;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
  }

  .modal h2 {
    font-family: 'Bangers', cursive;
    font-size: 1.8rem;
    letter-spacing: 2px;
    color: var(--gold);
    margin-bottom: 14px;
  }

  .modal-close {
    position: absolute; top: 12px; right: 12px;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    color: white; border-radius: 8px;
    padding: 4px 10px; cursor: pointer; font-size: 1rem;
  }

  .edit-row {
    display: flex; gap: 6px; align-items: center;
    margin-bottom: 6px;
  }

  .edit-row input, .edit-row select {
    flex: 1;
    background: rgba(255,255,255,0.08);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 6px 10px;
    color: white;
    font-family: 'Nunito', sans-serif;
    font-size: 0.85rem;
  }
  .edit-row input::placeholder { color: rgba(255,255,255,0.3); }

  .edit-section-title {
    font-family: 'Bangers', cursive;
    font-size: 1.1rem;
    color: rgba(255,255,255,0.6);
    letter-spacing: 1px;
    margin: 12px 0 6px;
  }

  .btn-primary {
    font-family: 'Bangers', cursive;
    font-size: 1rem;
    letter-spacing: 1px;
    padding: 8px 20px;
    border-radius: 10px;
    border: 2px solid var(--gold);
    background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,60,172,0.2));
    color: var(--gold);
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary:hover { background: linear-gradient(135deg, rgba(255,215,0,0.5), rgba(255,60,172,0.4)); }

  .btn-danger {
    background: rgba(255,60,60,0.2);
    border: 1.5px solid rgba(255,60,60,0.4);
    color: #ff6e6e;
    border-radius: 6px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.8rem;
  }
  .btn-danger:hover { background: rgba(255,60,60,0.4); }

  /* ‚îÄ‚îÄ CLAIM REWARD BUTTON ‚îÄ‚îÄ */
  .claim-btn {
    font-family: 'Bangers', cursive;
    font-size: 0.75rem;
    letter-spacing: 1px;
    padding: 2px 8px;
    border-radius: 6px;
    border: 1.5px solid rgba(255,215,0,0.5);
    background: rgba(255,215,0,0.15);
    color: var(--gold);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .claim-btn:hover { background: rgba(255,215,0,0.35); transform: scale(1.05); }
  .claim-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

  /* ‚îÄ‚îÄ RESET WEEK BUTTON ‚îÄ‚îÄ */
  .reset-btn {
    font-family: 'Permanent Marker', cursive;
    font-size: 0.7rem;
    padding: 3px 10px;
    border-radius: 8px;
    border: 1.5px solid rgba(255,100,100,0.5);
    background: rgba(255,60,60,0.15);
    color: rgba(255,140,140,0.9);
    cursor: pointer;
    transition: all 0.2s;
  }
  .reset-btn:hover { background: rgba(255,60,60,0.3); color: #ff9090; }

  /* ‚îÄ‚îÄ CLAIM TOAST ‚îÄ‚îÄ */
  .claim-toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.85);
    border: 2px solid var(--gold);
    border-radius: 12px;
    padding: 10px 24px;
    font-family: 'Bangers', cursive;
    font-size: 1.4rem;
    letter-spacing: 2px;
    color: var(--gold);
    z-index: 9999;
    animation: toastIn 0.3s ease, toastOut 0.4s ease 2.2s forwards;
    pointer-events: none;
  }
  @keyframes toastIn { from { opacity:0; transform: translateX(-50%) translateY(20px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }
  @keyframes toastOut { to { opacity:0; transform: translateX(-50%) translateY(20px); } }

  /* ‚îÄ‚îÄ RESET CONFIRM MODAL ‚îÄ‚îÄ */
  .confirm-modal {
    background: #1a1a2e;
    border: 3px solid rgba(255,100,100,0.6);
    border-radius: 16px;
    padding: 24px;
    width: 380px;
    max-width: 95vw;
    text-align: center;
  }
  .confirm-modal h2 {
    font-family: 'Bangers', cursive;
    font-size: 2rem;
    letter-spacing: 2px;
    color: #ff9090;
    margin-bottom: 10px;
  }
  .confirm-modal p {
    color: rgba(255,255,255,0.7);
    font-size: 0.9rem;
    margin-bottom: 20px;
    line-height: 1.5;
  }
  .confirm-btns { display: flex; gap: 10px; justify-content: center; }

  /* ‚îÄ‚îÄ SPARKLE ANIMATION ‚îÄ‚îÄ */
  @keyframes sparkle {
    0% { transform: scale(0) rotate(0deg); opacity: 1; }
    100% { transform: scale(3) rotate(180deg); opacity: 0; }
  }
  .sparkle {
    position: fixed; pointer-events: none; z-index: 999;
    font-size: 1.2rem; animation: sparkle 0.8s ease-out forwards;
  }

  /* ‚îÄ‚îÄ CHILD BANNER ‚îÄ‚îÄ */
  .child-banner {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 8px;
  }
  .child-name-big {
    font-family: 'Bangers', cursive;
    font-size: 2rem;
    letter-spacing: 3px;
  }
  .lily-name { 
    background: linear-gradient(90deg, #FFD700, #FF3CAC, #2B86C5, #6EFF9E, #FFD700);
    background-size: 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 4s linear infinite;
    filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.5));
  }
  .rue-name { 
    background: linear-gradient(90deg, #FFD700, #FF3CAC, #2B86C5, #6EFF9E, #FFD700);
    background-size: 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 4s linear infinite;
    animation-delay: 0.5s;
    filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.5));
  }

  /* Calendar add event btn */
  .add-event-btn {
    font-family: 'Bangers', cursive;
    font-size: 1rem;
    letter-spacing: 1px;
    padding: 6px 16px;
    border-radius: 10px;
    border: 2px solid #6EFF9E;
    background: rgba(110,255,158,0.15);
    color: #6EFF9E;
    cursor: pointer;
    transition: all 0.2s;
  }
  .add-event-btn:hover { background: rgba(110,255,158,0.3); }
</style>
</head>
<body>

<header>
  <div class="app-title">‚ú® CHORE STARS ‚ú®</div>
  <div class="header-right">
    <span id="syncStatus" style="font-family:'Permanent Marker',cursive;font-size:0.7rem;color:rgba(100,255,150,0.8);transition:opacity 0.5s;opacity:0;"></span>
    <div class="date-display" id="dateDisplay"></div>
    <button class="reset-btn" onclick="openResetConfirm()">üîÑ New Week</button>
  </div>
</header>

<!-- Loading overlay -->
<div id="loadingOverlay" style="position:fixed;inset:0;z-index:999;background:rgba(10,10,30,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
  <div style="font-family:'Bangers',cursive;font-size:3rem;letter-spacing:4px;background:linear-gradient(90deg,#FFD700,#FF3CAC,#2B86C5,#FFD700);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 2s linear infinite;">‚ú® CHORE STARS ‚ú®</div>
  <div style="font-family:'Permanent Marker',cursive;color:rgba(255,255,255,0.6);font-size:1rem;">Connecting to Firebase‚Ä¶</div>
  <div style="width:60px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
    <div style="height:100%;background:linear-gradient(90deg,#FFD700,#FF3CAC);animation:loadBar 1.2s ease-in-out infinite;border-radius:2px;"></div>
  </div>
</div>
<style>
@keyframes loadBar { 0%{width:0%;margin-left:0} 50%{width:100%;margin-left:0} 100%{width:0%;margin-left:100%} }
</style>

<div class="tabs">
  <button class="tab-btn lily active" onclick="switchTab('lily')">üå∏ LILY</button>
  <button class="tab-btn rue"  onclick="switchTab('rue')">üíô RUE</button>
  <button class="tab-btn cal"  onclick="switchTab('cal')">üìÖ FAMILY</button>
</div>

<div class="main-panel">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LILY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-content active" id="tab-lily">
    <div class="child-banner">
      <span class="child-name-big lily-name">üå∏ LILY</span>
      <button class="edit-btn" onclick="openEditChores('lily')">‚úèÔ∏è Edit Chores</button>
      <button class="edit-btn" onclick="openEditRewards('lily')">üèÜ Edit Rewards</button>
      <div style="margin-left:auto;" id="lily-star-bar"></div>
    </div>
    <div class="chore-tab-inner">
      <div class="left-col">
        <div class="day-selector" id="lily-days"></div>
        <div class="rewards-box">
          <div class="rewards-title">üèÜ REWARDS <span style="font-size:0.7rem;color:rgba(255,255,255,0.4);font-family:Nunito">pts</span></div>
          <div id="lily-rewards-list"></div>
          <div style="margin-top:8px;padding-top:6px;border-top:1px solid rgba(255,215,0,0.2);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
              <span style="font-family:Bangers,cursive;font-size:0.85rem;letter-spacing:1px;color:rgba(255,215,0,0.6);">üìú CLAIMED</span>
              <button class="edit-btn" onclick="resetClaimHistory('lily')" style="font-size:0.6rem;padding:1px 6px;border-color:rgba(255,100,100,0.4);color:rgba(255,140,140,0.7);">üîÑ Reset</button>
            </div>
            <div id="lily-claim-history"></div>
          </div>
        </div>
      </div>
      <div class="right-col">
        <div class="chore-section morning">
          <div class="section-header morning-hdr">‚òÄÔ∏è MORNING</div>
          <div class="chore-list" id="lily-morning-list"></div>
        </div>
        <div class="chore-section afternoon">
          <div class="section-header afternoon-hdr">üåô AFTERNOON</div>
          <div class="chore-list" id="lily-afternoon-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RUE TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-rue">
    <div class="child-banner">
      <span class="child-name-big rue-name">üíô RUE</span>
      <button class="edit-btn" onclick="openEditChores('rue')">‚úèÔ∏è Edit Chores</button>
      <button class="edit-btn" onclick="openEditRewards('rue')">üèÜ Edit Rewards</button>
      <div style="margin-left:auto;" id="rue-star-bar"></div>
    </div>
    <div class="chore-tab-inner">
      <div class="left-col">
        <div class="day-selector" id="rue-days"></div>
        <div class="rewards-box">
          <div class="rewards-title">üèÜ REWARDS</div>
          <div id="rue-rewards-list"></div>
          <div style="margin-top:8px;padding-top:6px;border-top:1px solid rgba(255,215,0,0.2);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
              <span style="font-family:Bangers,cursive;font-size:0.85rem;letter-spacing:1px;color:rgba(255,215,0,0.6);">üìú CLAIMED</span>
              <button class="edit-btn" onclick="resetClaimHistory('rue')" style="font-size:0.6rem;padding:1px 6px;border-color:rgba(255,100,100,0.4);color:rgba(255,140,140,0.7);">üîÑ Reset</button>
            </div>
            <div id="rue-claim-history"></div>
          </div>
        </div>
      </div>
      <div class="right-col">
        <div class="chore-section morning">
          <div class="section-header morning-hdr">‚òÄÔ∏è MORNING</div>
          <div class="chore-list" id="rue-morning-list"></div>
        </div>
        <div class="chore-section afternoon">
          <div class="section-header afternoon-hdr">üåô AFTERNOON</div>
          <div class="chore-list" id="rue-afternoon-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALENDAR TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-cal">
    <div class="cal-inner">
      <div class="cal-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
        <div class="cal-title" id="calTitle"></div>
        <button class="add-event-btn" onclick="openAddEvent()">+ ADD EVENT</button>
        <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <!-- legend -->
      <div style="display:flex;gap:12px;padding:2px 4px;">
        <span style="font-size:0.72rem;color:#FF6EFF">üå∏ Lily</span>
        <span style="font-size:0.72rem;color:#6EEFFF">üíô Rue</span>
        <span style="font-size:0.72rem;color:#6EFF9E">üë®‚Äçüë©‚Äçüëß Family</span>
      </div>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- Reset Confirm Modal -->
<div class="modal-overlay" id="resetConfirmModal">
  <div class="confirm-modal">
    <h2>üîÑ NEW WEEK?</h2>
    <p>This will clear all ticked chores for both Lily and Rue.<br>
    <strong style="color:var(--gold)">‚≠ê Star totals and claimed rewards are kept!</strong></p>
    <div class="confirm-btns">
      <button class="btn-primary" onclick="confirmReset()" style="border-color:#ff9090;color:#ff9090;background:rgba(255,100,100,0.2)">‚úÖ Yes, Reset Week</button>
      <button class="btn-primary" onclick="closeModal('resetConfirmModal')">‚ùå Cancel</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="editChoresModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('editChoresModal')">‚úï</button>
    <h2 id="editChoresTitle">‚úèÔ∏è EDIT CHORES</h2>
    <div class="edit-section-title">‚òÄÔ∏è Morning Chores</div>
    <div id="editMorningList"></div>
    <div class="edit-row" style="margin-top:6px;">
      <input id="newMorningIcon" placeholder="Icon ü¶∑" style="width:60px;flex:none">
      <input id="newMorningName" placeholder="New morning chore...">
      <button class="btn-primary" onclick="addChore('morning')">+ ADD</button>
    </div>
    <div class="edit-section-title">üåô Afternoon Chores</div>
    <div id="editAfternoonList"></div>
    <div class="edit-row" style="margin-top:6px;">
      <input id="newAfternoonIcon" placeholder="Icon üìö" style="width:60px;flex:none">
      <input id="newAfternoonName" placeholder="New afternoon chore...">
      <button class="btn-primary" onclick="addChore('afternoon')">+ ADD</button>
    </div>
    <div style="margin-top:14px;font-size:0.75rem;color:rgba(255,255,255,0.4)">
      üí° Weekend chores are the same but Pack Lunchbox, Pack Bag & Unpack Bag are auto-hidden on Sat/Sun for Rue.
    </div>
    <div style="margin-top:10px;display:flex;justify-content:flex-end;">
      <button class="btn-primary" onclick="saveChores()">üíæ SAVE</button>
    </div>
  </div>
</div>

<!-- Edit Rewards Modal -->
<div class="modal-overlay" id="editRewardsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('editRewardsModal')">‚úï</button>
    <h2 id="editRewardsTitle">üèÜ EDIT REWARDS</h2>
    <div id="editRewardsList"></div>
    <div class="edit-row" style="margin-top:8px;">
      <input id="newRewardName" placeholder="Reward name...">
      <input id="newRewardPts" placeholder="‚≠ê pts" style="width:80px;flex:none" type="number">
      <button class="btn-primary" onclick="addReward()">+ ADD</button>
    </div>
    <div style="margin-top:14px;display:flex;justify-content:flex-end;">
      <button class="btn-primary" onclick="saveRewards()">üíæ SAVE</button>
    </div>
  </div>
</div>

<!-- Add Event Modal -->
<div class="modal-overlay" id="addEventModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addEventModal')">‚úï</button>
    <h2>üìÖ ADD EVENT</h2>
    <div class="edit-row">
      <input id="eventDate" type="date">
    </div>
    <div class="edit-row">
      <input id="eventText" placeholder="Event description...">
    </div>
    <div class="edit-row">
      <select id="eventType">
        <option value="family">üë®‚Äçüë©‚Äçüëß Family</option>
        <option value="lily">üå∏ Lily</option>
        <option value="rue">üíô Rue</option>
      </select>
    </div>
    <div style="margin-top:14px;display:flex;justify-content:flex-end;">
      <button class="btn-primary" onclick="saveEvent()">üíæ SAVE</button>
    </div>
  </div>
</div>

<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getDatabase, ref, set, get, onValue, update, remove }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyDZXfG1uE39ituMY8xD8PYjZdFFG2Vc_KU",
  authDomain: "chore-chart-54d54.firebaseapp.com",
  projectId: "chore-chart-54d54",
  storageBucket: "chore-chart-54d54.firebasestorage.app",
  messagingSenderId: "341347519615",
  appId: "1:341347519615:web:2c86fafc8b39b5306ac34a",
  databaseURL: "https://chore-chart-54d54-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// ‚îÄ‚îÄ DB helpers ‚îÄ‚îÄ
const dbRef  = (path) => ref(db, path);
const dbSet  = (path, val) => set(dbRef(path), val);
const dbGet  = (path) => get(dbRef(path));
const dbOn   = (path, cb) => onValue(dbRef(path), snap => cb(snap.val()));

// Show a subtle "syncing" indicator
function setSyncStatus(syncing) {
  const el = document.getElementById('syncStatus');
  if (!el) return;
  el.textContent = syncing ? 'üîÑ Saving‚Ä¶' : '‚úÖ Saved';
  el.style.opacity = '1';
  if (!syncing) setTimeout(() => { el.style.opacity = '0'; }, 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA DEFAULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const WEEKEND = [5,6];

const DEFAULT_CHORES = {
  lily: {
    morning: [
      {icon:'ü•£', name:'Eat Breakfast', weekdayOnly:false},
      {icon:'ü¶∑', name:'Brush Teeth', weekdayOnly:false},
      {icon:'üëó', name:'Get Dressed', weekdayOnly:false},
      {icon:'üíá', name:'Brush Hair', weekdayOnly:false},
      {icon:'üêæ', name:'Feed Animals', weekdayOnly:false},
      {icon:'üéí', name:'Pack Bag', weekdayOnly:true},
      {icon:'ü•™', name:'Pack Lunchbox', weekdayOnly:true},
    ],
    afternoon: [
      {icon:'üéí', name:'Unpack Bag', weekdayOnly:true},
      {icon:'üßπ', name:'Tidy Room', weekdayOnly:false},
      {icon:'üçΩÔ∏è', name:'Unpack Dishwasher', weekdayOnly:false},
      {icon:'üêæ', name:'Feed Animals', weekdayOnly:false},
    ]
  },
  rue: {
    morning: [
      {icon:'üöΩ', name:'Toilet', weekdayOnly:false},
      {icon:'ü•£', name:'Eat Breakfast', weekdayOnly:false},
      {icon:'ü¶∑', name:'Brush Teeth', weekdayOnly:false},
      {icon:'üëó', name:'Get Dressed', weekdayOnly:false},
      {icon:'üíá', name:'Brush Hair', weekdayOnly:false},
      {icon:'üêæ', name:'Feed Animals', weekdayOnly:false},
      {icon:'üéí', name:'Pack Bag', weekdayOnly:true},
      {icon:'ü•™', name:'Pack Lunchbox', weekdayOnly:true},
    ],
    afternoon: [
      {icon:'üéí', name:'Unpack Bag', weekdayOnly:true},
      {icon:'üßπ', name:'Tidy Room', weekdayOnly:false},
      {icon:'üçΩÔ∏è', name:'Unpack Dishwasher', weekdayOnly:false},
      {icon:'üêæ', name:'Feed Animals', weekdayOnly:false},
    ]
  }
};

const DEFAULT_REWARDS = {
  lily: [
    {name:'Extra Screen Time (30min)', pts:5},
    {name:'Choose Dinner', pts:7},
    {name:'Movie Night Pick', pts:10},
    {name:'Stay Up 30min Late', pts:8},
    {name:'Special Outing', pts:20},
  ],
  rue: [
    {name:'Extra Screen Time (30min)', pts:5},
    {name:'Choose Dinner', pts:7},
    {name:'Movie Night Pick', pts:10},
    {name:'Stay Up 30min Late', pts:8},
    {name:'Special Outing', pts:20},
  ]
};

// ‚îÄ‚îÄ In-memory state (synced from Firebase) ‚îÄ‚îÄ
let state = {
  chores:   JSON.parse(JSON.stringify(DEFAULT_CHORES)),
  rewards:  JSON.parse(JSON.stringify(DEFAULT_REWARDS)),
  checked:  {},
  events:   [],
  starBank: { lily: 0, rue: 0 },
  claimHistory: { lily: [], rue: [] },
  selectedDay: { lily: getTodayIndex(), rue: getTodayIndex() },
  calMonth: new Date().getMonth(),
  calYear:  new Date().getFullYear(),
  editingChild: 'lily',
  loaded: false
};

function getTodayIndex() {
  const d = new Date().getDay();
  return d === 0 ? 6 : d - 1;
}

// ‚îÄ‚îÄ Save individual sections to Firebase ‚îÄ‚îÄ
async function saveSection(section) {
  setSyncStatus(true);
  try {
    let val = state[section];
    // Firebase can't store plain arrays well ‚Äî convert to indexed objects
    if (section === 'events') {
      val = state.events.reduce((acc, ev, i) => { acc[i] = ev; return acc; }, {});
    }
    if (section === 'claimHistory') {
      val = {
        lily: (state.claimHistory.lily || []).reduce((acc, h, i) => { acc[i] = h; return acc; }, {}),
        rue:  (state.claimHistory.rue  || []).reduce((acc, h, i) => { acc[i] = h; return acc; }, {})
      };
    }
    await dbSet(section, val);
  } catch(e) {
    console.error('Firebase save error:', e);
    showToast('‚ö†Ô∏è Save failed ‚Äî check connection');
  } finally {
    setSyncStatus(false);
  }
}

// Convenience: save everything (used sparingly)
function save() {
  saveSection('chores');
  saveSection('rewards');
  saveSection('checked');
  saveSection('events');
  saveSection('starBank');
}

// ‚îÄ‚îÄ Daily background ‚îÄ‚îÄ
function applyDayBackground() {
  const d = new Date().getDay();
  document.body.className = 'day-' + d;
}

// ‚îÄ‚îÄ Date display ‚îÄ‚îÄ
function updateDateDisplay() {
  const now = new Date();
  const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric' };
  document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-GB', opts);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderChild(child) {
  renderDaySelector(child);
  renderChores(child);
  renderRewards(child);
  renderStarBar(child);
}

function renderDaySelector(child) {
  const container = document.getElementById(child + '-days');
  container.innerHTML = '';
  DAYS.forEach((day, i) => {
    const isWeekend = WEEKEND.includes(i);
    const btn = document.createElement('button');
    btn.className = 'day-btn' + (isWeekend ? ' weekend' : '') + (state.selectedDay[child] === i ? ' active-day' : '');
    const key = child + '_' + i;
    const total = countTotal(child, i);
    const done = countDone(child, i);
    btn.innerHTML = `${day.slice(0,3)} <span style="float:right;font-size:0.75rem;color:${done===total?'#64ff96':'rgba(255,255,255,0.4)'}">${done}/${total}</span>`;
    btn.onclick = () => { state.selectedDay[child] = i; renderChild(child); };
    container.appendChild(btn);
  });
}

function getVisibleChores(child, period, dayIndex) {
  const isWeekend = WEEKEND.includes(dayIndex);
  return state.chores[child][period].filter(c => !(isWeekend && c.weekdayOnly));
}

function countTotal(child, dayIndex) {
  return getVisibleChores(child, 'morning', dayIndex).length +
         getVisibleChores(child, 'afternoon', dayIndex).length;
}

function countDone(child, dayIndex) {
  const key = child + '_' + dayIndex;
  const checked = state.checked[key] || {};
  let count = 0;
  ['morning','afternoon'].forEach(p => {
    getVisibleChores(child, p, dayIndex).forEach(c => {
      if (checked[p + '_' + c.name]) count++;
    });
  });
  return count;
}

function renderChores(child) {
  const dayIndex = state.selectedDay[child];
  ['morning','afternoon'].forEach(period => {
    const list = document.getElementById(child + '-' + period + '-list');
    list.innerHTML = '';
    const key = child + '_' + dayIndex;
    const checked = state.checked[key] || {};
    const chores = getVisibleChores(child, period, dayIndex);
    chores.forEach((chore, i) => {
      const ck = period + '_' + chore.name;
      const done = !!checked[ck];
      const item = document.createElement('div');
      item.className = 'chore-item' + (done ? ' done' : '');
      item.innerHTML = `
        <div class="chore-check">${done ? '‚úì' : ''}</div>
        <div class="chore-icon">${chore.icon}</div>
        <div class="chore-name">${chore.name}</div>
      `;
      item.onclick = (e) => toggleChore(child, dayIndex, period, chore.name, e);
      list.appendChild(item);
    });
  });
  renderStarBar(child);
}

function renderRewards(child) {
  const list = document.getElementById(child + '-rewards-list');
  list.innerHTML = '';
  const avail = state.starBank[child] || 0;
  (state.rewards[child] || []).forEach((r, i) => {
    const canAfford = avail >= r.pts;
    const item = document.createElement('div');
    item.className = 'reward-item';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = r.name;

    const ptsSpan = document.createElement('span');
    ptsSpan.className = 'reward-pts';
    ptsSpan.textContent = '\u2b50' + r.pts;

    const claimBtn = document.createElement('button');
    claimBtn.className = 'claim-btn';
    claimBtn.textContent = 'CLAIM';
    claimBtn.disabled = !canAfford;
    claimBtn.addEventListener('click', (e) => claimReward(child, i, e));

    item.appendChild(nameSpan);
    item.appendChild(ptsSpan);
    item.appendChild(claimBtn);
    list.appendChild(item);
  });
}

function renderStarBar(child) {
  const total = state.starBank[child];
  const bar = document.getElementById(child + '-star-bar');
  const starDisplay = Math.min(total, 20);
  let html = `<div class="star-bar"><span class="stars-count">‚≠ê ${total} available</span><div class="star-icons">`;
  for (let i = 0; i < starDisplay; i++) html += `<span class="star-pip">‚≠ê</span>`;
  if (total > 20) html += `<span style="color:var(--gold);font-size:0.75rem;font-family:'Bangers'"> +${total-20}</span>`;
  html += `</div></div>`;
  bar.innerHTML = html;
}

function getTotalStars(child) {
  return state.starBank[child] || 0;
}

function toggleChore(child, dayIndex, period, choreName, e) {
  const key = child + '_' + dayIndex;
  if (!state.checked[key]) state.checked[key] = {};
  const ck = period + '_' + choreName;
  const wasDone = !!state.checked[key][ck];
  state.checked[key][ck] = !wasDone;
  // Update star bank
  if (!wasDone) {
    state.starBank[child] = (state.starBank[child] || 0) + 1;
  } else {
    state.starBank[child] = Math.max(0, (state.starBank[child] || 0) - 1);
  }
  saveSection('checked');
  saveSection('starBank');
  if (!wasDone) spawnSparkle(e);
}

function spawnSparkle(e) {
  const sparkles = ['‚≠ê','‚ú®','üåü','üí´','üéâ'];
  for (let i = 0; i < 5; i++) {
    const el = document.createElement('div');
    el.className = 'sparkle';
    el.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
    el.style.left = (e.clientX + (Math.random()-0.5)*60) + 'px';
    el.style.top = (e.clientY + (Math.random()-0.5)*60) + 'px';
    el.style.animationDelay = (i * 0.1) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1000);
  }
}

function claimReward(child, rewardIndex, e) {
  const reward = state.rewards[child][rewardIndex];
  if (!reward || (state.starBank[child] || 0) < reward.pts) return;
  state.starBank[child] = (state.starBank[child] || 0) - reward.pts;
  // Record in claim history
  if (!state.claimHistory[child]) state.claimHistory[child] = [];
  state.claimHistory[child].push({
    name: reward.name,
    pts: reward.pts,
    date: new Date().toLocaleDateString('en-GB')
  });
  saveSection('starBank');
  saveSection('claimHistory');
  // Big celebration sparkles
  for (let i = 0; i < 15; i++) {
    const el = document.createElement('div');
    el.className = 'sparkle';
    el.textContent = ['üèÜ','üéâ','‚≠ê','üåü','‚ú®','üéä'][Math.floor(Math.random()*6)];
    el.style.left = (Math.random() * window.innerWidth) + 'px';
    el.style.top = (Math.random() * window.innerHeight) + 'px';
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1200);
  }
  showToast('üèÜ ' + child.charAt(0).toUpperCase()+child.slice(1) + ' claimed: ' + reward.name + '! (-' + reward.pts + '‚≠ê)');
}

function resetClaimHistory(child) {
  if (!confirm('Reset all claimed rewards for ' + child.charAt(0).toUpperCase()+child.slice(1) + '?')) return;
  state.claimHistory[child] = [];
  saveSection('claimHistory');
  showToast('üîÑ Claimed rewards reset for ' + child.charAt(0).toUpperCase()+child.slice(1));
}

function renderClaimHistory(child) {
  const el = document.getElementById(child + '-claim-history');
  if (!el) return;
  const history = (state.claimHistory && state.claimHistory[child]) ? state.claimHistory[child] : [];
  if (history.length === 0) {
    el.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-size:0.72rem;font-style:italic;padding:4px 0;">No rewards claimed yet</div>';
    return;
  }
  el.innerHTML = '';
  // Show most recent first, max 5
  [...history].reverse().slice(0, 5).forEach(h => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.06);';
    row.innerHTML = '<span style="font-size:0.7rem;color:rgba(255,215,0,0.8);flex:1;">' + h.name + '</span>'
      + '<span style="font-size:0.68rem;color:rgba(255,255,255,0.3);">' + h.date + '</span>'
      + '<span style="font-family:Bangers,cursive;color:#ff9090;font-size:0.85rem;">-' + h.pts + '‚≠ê</span>';
    el.appendChild(row);
  });
  if (history.length > 5) {
    const more = document.createElement('div');
    more.style.cssText = 'font-size:0.65rem;color:rgba(255,255,255,0.25);text-align:right;padding-top:2px;';
    more.textContent = '+ ' + (history.length - 5) + ' more';
    el.appendChild(more);
  }
}

function showToast(msg) {
  const el = document.createElement('div');
  el.className = 'claim-toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2700);
}

function openResetConfirm() {
  openModal('resetConfirmModal');
}

function confirmReset() {
  state.checked = {};
  saveSection('checked');
  closeModal('resetConfirmModal');
  showToast('üîÑ New week started! Chores reset for Lily & Rue.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCalendar() {
  const { calMonth, calYear } = state;
  const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calTitle').textContent = MONTH_NAMES[calMonth] + ' ' + calYear;

  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  // Headers
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => {
    const h = document.createElement('div');
    h.className = 'cal-day-header'; h.textContent = d;
    grid.appendChild(h);
  });

  const firstDay = new Date(calYear, calMonth, 1).getDay(); // 0=Sun
  const startOffset = firstDay === 0 ? 6 : firstDay - 1;
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
  const daysInPrevMonth = new Date(calYear, calMonth, 0).getDate();

  const today = new Date();
  const totalCells = Math.ceil((startOffset + daysInMonth) / 7) * 7;

  for (let i = 0; i < totalCells; i++) {
    const cell = document.createElement('div');
    let date, month, year, otherMonth = false;

    if (i < startOffset) {
      date = daysInPrevMonth - startOffset + i + 1;
      month = calMonth === 0 ? 11 : calMonth - 1;
      year = calMonth === 0 ? calYear - 1 : calYear;
      otherMonth = true;
    } else if (i >= startOffset + daysInMonth) {
      date = i - startOffset - daysInMonth + 1;
      month = calMonth === 11 ? 0 : calMonth + 1;
      year = calMonth === 11 ? calYear + 1 : calYear;
      otherMonth = true;
    } else {
      date = i - startOffset + 1;
      month = calMonth; year = calYear;
    }

    cell.className = 'cal-cell' + (otherMonth ? ' other-month' : '');
    const isToday = date === today.getDate() && month === today.getMonth() && year === today.getFullYear();
    if (isToday) cell.classList.add('today');

    const dateStr = year + '-' + String(month+1).padStart(2,'0') + '-' + String(date).padStart(2,'0');
    cell.innerHTML = `<div class="cal-date">${date}</div>`;

    // Events
    state.events.filter(e => e.date === dateStr).forEach(ev => {
      const tag = document.createElement('div');
      tag.className = 'cal-event event-' + ev.type;
      const icons = {lily:'üå∏',rue:'üíô',family:'üë®‚Äçüë©‚Äçüëß'};
      tag.textContent = icons[ev.type] + ' ' + ev.text;
      tag.title = 'Click to delete';
      const evRef = ev;
      tag.onclick = (e) => { 
        e.stopPropagation(); 
        if(confirm('Delete "'+evRef.text+'"?')) { 
          state.events = state.events.filter(x=>x!==evRef); 
          saveSection('events');
        } 
      };
      cell.appendChild(tag);
    });

    // Click to add event on that date
    cell.onclick = () => { document.getElementById('eventDate').value = dateStr; openModal('addEventModal'); };
    grid.appendChild(cell);
  }
}

function changeMonth(dir) {
  state.calMonth += dir;
  if (state.calMonth > 11) { state.calMonth = 0; state.calYear++; }
  if (state.calMonth < 0) { state.calMonth = 11; state.calYear--; }
  renderCalendar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openEditChores(child) {
  state.editingChild = child;
  document.getElementById('editChoresTitle').textContent = `‚úèÔ∏è ${child.toUpperCase()}'S CHORES`;
  populateEditChores();
  openModal('editChoresModal');
}

function populateEditChores() {
  const child = state.editingChild;
  ['morning','afternoon'].forEach(period => {
    const list = document.getElementById('edit' + period.charAt(0).toUpperCase() + period.slice(1) + 'List');
    list.innerHTML = '';
    state.chores[child][period].forEach((c, i) => {
      const row = document.createElement('div');
      row.className = 'edit-row';

      const iconInput = document.createElement('input');
      iconInput.value = c.icon;
      iconInput.style.cssText = 'width:60px;flex:none';
      iconInput.addEventListener('change', () => { state.chores[child][period][i].icon = iconInput.value; });

      const nameInput = document.createElement('input');
      nameInput.value = c.name;
      nameInput.addEventListener('change', () => { state.chores[child][period][i].name = nameInput.value; });

      const label = document.createElement('label');
      label.style.cssText = 'color:rgba(255,255,255,0.5);font-size:0.75rem;white-space:nowrap;display:flex;align-items:center;gap:4px;';
      const cbx = document.createElement('input');
      cbx.type = 'checkbox';
      cbx.checked = !!c.weekdayOnly;
      cbx.addEventListener('change', () => { state.chores[child][period][i].weekdayOnly = cbx.checked; });
      label.appendChild(cbx);
      label.appendChild(document.createTextNode(' School days only'));

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-danger';
      delBtn.textContent = '‚úï';
      delBtn.addEventListener('click', () => removeChore(period, i));

      row.appendChild(iconInput);
      row.appendChild(nameInput);
      row.appendChild(label);
      row.appendChild(delBtn);
      list.appendChild(row);
    });
  });
}

function addChore(period) {
  const iconInput = document.getElementById('new' + period.charAt(0).toUpperCase() + period.slice(1) + 'Icon');
  const nameInput = document.getElementById('new' + period.charAt(0).toUpperCase() + period.slice(1) + 'Name');
  if (!nameInput.value.trim()) return;
  state.chores[state.editingChild][period].push({
    icon: iconInput.value || 'üìå',
    name: nameInput.value.trim(),
    weekdayOnly: false
  });
  iconInput.value = '';
  nameInput.value = '';
  populateEditChores();
}

function removeChore(period, index) {
  state.chores[state.editingChild][period].splice(index, 1);
  populateEditChores();
}

function saveChores() {
  saveSection('chores');
  closeModal('editChoresModal');
}

function openEditRewards(child) {
  state.editingChild = child;
  document.getElementById('editRewardsTitle').textContent = `üèÜ ${child.toUpperCase()}'S REWARDS`;
  populateEditRewards();
  openModal('editRewardsModal');
}

function populateEditRewards() {
  const child = state.editingChild;
  const list = document.getElementById('editRewardsList');
  list.innerHTML = '';
  (state.rewards[child] || []).forEach((r, i) => {
    const row = document.createElement('div');
    row.className = 'edit-row';

    const nameInput = document.createElement('input');
    nameInput.value = r.name;
    nameInput.addEventListener('change', () => { state.rewards[child][i].name = nameInput.value; });

    const ptsInput = document.createElement('input');
    ptsInput.type = 'number';
    ptsInput.value = r.pts;
    ptsInput.style.cssText = 'width:80px;flex:none';
    ptsInput.addEventListener('change', () => { state.rewards[child][i].pts = parseInt(ptsInput.value) || 0; });

    const delBtn = document.createElement('button');
    delBtn.className = 'btn-danger';
    delBtn.textContent = '‚úï';
    delBtn.addEventListener('click', () => removeReward(i));

    row.appendChild(nameInput);
    row.appendChild(ptsInput);
    row.appendChild(delBtn);
    list.appendChild(row);
  });
}

function addReward() {
  const name = document.getElementById('newRewardName').value.trim();
  const pts = parseInt(document.getElementById('newRewardPts').value) || 5;
  if (!name) return;
  state.rewards[state.editingChild].push({name, pts});
  document.getElementById('newRewardName').value = '';
  document.getElementById('newRewardPts').value = '';
  populateEditRewards();
}

function removeReward(index) {
  state.rewards[state.editingChild].splice(index, 1);
  populateEditRewards();
}

function saveRewards() {
  saveSection('rewards');
  closeModal('editRewardsModal');
}

function openAddEvent() {
  const today = new Date();
  document.getElementById('eventDate').value = today.toISOString().split('T')[0];
  openModal('addEventModal');
}

function saveEvent() {
  const date = document.getElementById('eventDate').value;
  const text = document.getElementById('eventText').value.trim();
  const type = document.getElementById('eventType').value;
  if (!date || !text) return;
  state.events.push({date, text, type});
  document.getElementById('eventText').value = '';
  saveSection('events');
  closeModal('addEventModal');
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.tab-btn.${tab}`).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'cal') renderCalendar();
}

// Expose tab switch globally (called from onclick in HTML)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE REAL-TIME LISTENERS + BOOTSTRAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Show loading overlay until data arrives
function showLoading(show) {
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

async function bootstrap() {
  showLoading(true);

  // Check if DB has data; if not, write defaults
  const snap = await dbGet('chores');
  if (!snap.exists()) {
    // First run ‚Äî seed the database with defaults
    await dbSet('chores',   DEFAULT_CHORES);
    await dbSet('rewards',  DEFAULT_REWARDS);
    await dbSet('checked',  {});
    await dbSet('events',   {});
    await dbSet('starBank', { lily: 0, rue: 0 });
    await dbSet('claimHistory', { lily: [], rue: [] });
  }

  // ‚îÄ‚îÄ Real-time listeners ‚Äî update state & re-render whenever Firebase changes ‚îÄ‚îÄ

  dbOn('chores', val => {
    if (val) {
      state.chores = val;
      // Firebase stores arrays as objects with numeric keys ‚Äî normalise
      ['lily','rue'].forEach(child => {
        ['morning','afternoon'].forEach(period => {
          if (state.chores[child] && state.chores[child][period]) {
            state.chores[child][period] = Object.values(state.chores[child][period]);
          }
        });
      });
    }
    renderChild('lily');
    renderChild('rue');
    showLoading(false);
  });

  dbOn('rewards', val => {
    if (val) {
      state.rewards = val;
      ['lily','rue'].forEach(child => {
        if (state.rewards[child]) {
          state.rewards[child] = Object.values(state.rewards[child]);
        }
      });
    }
    renderChild('lily');
    renderChild('rue');
  });

  dbOn('checked', val => {
    state.checked = val || {};
    renderChild('lily');
    renderChild('rue');
  });

  dbOn('events', val => {
    // Re-hydrate from Firebase object ‚Üí array
    state.events = val ? Object.values(val) : [];
    renderCalendar();
  });

  dbOn('starBank', val => {
    state.starBank = val || { lily: 0, rue: 0 };
    renderStarBar('lily');
    renderStarBar('rue');
    renderRewards('lily');
    renderRewards('rue');
  });

  dbOn('claimHistory', val => {
    if (val) {
      state.claimHistory = {
        lily: Array.isArray(val.lily) ? val.lily : Object.values(val.lily || {}),
        rue:  Array.isArray(val.rue)  ? val.rue  : Object.values(val.rue  || {})
      };
    }
    renderClaimHistory('lily');
    renderClaimHistory('rue');
  });
}

// ‚îÄ‚îÄ Expose all functions used in HTML onclick attributes ‚îÄ‚îÄ
// (required because this is a type="module" script)
window.switchTab         = switchTab;
window.openEditChores    = openEditChores;
window.openEditRewards   = openEditRewards;
window.addChore          = addChore;
window.removeChore       = removeChore;
window.saveChores        = saveChores;
window.addReward         = addReward;
window.removeReward      = removeReward;
window.saveRewards       = saveRewards;
window.openAddEvent      = openAddEvent;
window.saveEvent         = saveEvent;
window.openModal         = openModal;
window.closeModal        = closeModal;
window.changeMonth       = changeMonth;
window.openResetConfirm  = openResetConfirm;
window.confirmReset      = confirmReset;
window.resetClaimHistory = resetClaimHistory;
window.claimReward       = claimReward;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
applyDayBackground();
updateDateDisplay();
bootstrap();
</script>
</body>
</html>
